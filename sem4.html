<html>

<head>
	<script src="http://code.jquery.com/jquery-1.11.1.js"></script>
	<script src="/socket.io/socket.io.js"></script>
	<script>
		var socket = io();
		
		// Moved socket commands to functions
		getMessageList = function (cb) {
			socket.emit('get message list', cb);
		}

		// Moved socket commands to functions
		postMessage = function (message, from, cb) {
			socket.emit('post message', message, from, cb);
		}

		socket.on('message list', function (data, cb) {

			console.log(data);
			var ml = JSON.parse(data);
			
			// Clean message list before refreshing it
			$('#ml').empty();

			for (var i in ml) {
				ml[i].ts = new Date(ml[i].ts);

				item = 'Autor:' + ml[i].from + ', ts: ' + ml[i].ts.toLocaleString() +
					', msg: ' + ml[i].msg;

				$('#ml').append($('<li>').html(item));
			}

			// Callback for functions chaining after socket response
			if (cb) {
				cb();
			}
		});

		socket.on('message posted', function (cb) {
			if (cb) {
				cb();
			}
		});

		getMessageList(function () {
			postMessage('Hola Mundo', 'mudito', function () {
				getMessageList();
			});
		});		

	</script>

<body>

	<p>LISTA:</p>
	<ul id='ml'>
	</ul>

</body>

</html>